<html>

<head>
    <link rel="stylesheet" href="estellestyles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>
    <script src="scroll.js"></script>
    <title>Fishy Business</title>
</head>

<body>

    <div id="graphic">
        <div id="vis">
            <!-- <div class="alignVertical"> -->
            <div class="menu fancyFont alignVertical">
                <h2>Catch of the Day</h2>
                <!-- Salmon Order -->
                <div class="order alignVertical">
                    <text id=salmon class="menuTitle hover-underline-animation fadeAnimation">Miso
                        Salmon | $31</text>
                    <p>Served with bok choy, ginger rice, and microgreens.</p>
                </div>
                <!-- Shrimp Order -->
                <div class="order alignVertical">
                    <text id=shrimp class="menuTitle hover-underline-animation fadeAnimation">Spicy
                        Cajun Shrimp | $27</text>
                    <p>Served with cheesy grits and a big spoon.</p>

                </div>
                <!-- Tilapia Order -->
                <div class="order alignVertical">
                    <text id=tilapia class="menuTitle hover-underline-animation fadeAnimation">Fried
                        Tilapia Sandwich | $23</text>
                    <p>Served with coleslaw, pickles, tartar sauce, and a side of fries.</p>
                </div>
                <!-- </div> -->
            </div>

            <div class="receipt hidden">
                <h2></h2>
                <h3></h3>
                <hr class="dashed-line">
                <table>
                    <col width="70%">
                    <col width="30%">
                    <tr>
                        <th id="dishName"></th>
                        <th id="dishPrice"></th>
                    </tr>
                    <tr>
                        <th id="water"></th>
                        <th id="waterPrice"></th>
                    </tr>
                    <tr>
                        <th id="land"></th>
                        <th id="landPrice"></th>
                    </tr>
                    <tr>
                        <th id="nitrogen"></th>
                        <th id="nitrogenPrice"></th>
                    </tr>
                    <tr>
                        <th id="phos"></th>
                        <th id="phosPrice"></th>
                    </tr>
                </table>
                <hr class="dashed-line">
            </div>

            <!-- <div class="receipt fancyFont alignVertical hidden">
                <h2>Fishy Business</h2>
                <h3>www.fishy-business.onrender.com</h3>
                <hr class="dashed-line">
                <table>
                    <col width="70%">
                    <col width="30%">
                    <tr>
                        <th id="dishName"></th>
                        <th id="dishPrice"></th>
                    </tr>
                    <tr>
                        <th>Water</th>
                        <th id="waterPrice"></th>
                    </tr>
                    <tr>
                        <th>Land</th>
                        <th id="landPrice"></th>
                    </tr>
                    <tr>
                        <th>Nitrogen</th>
                        <th id="nitrogenPrice"></th>
                    </tr>
                    <tr>
                        <th>Phosphorous</th>
                        <th id="phosphorous"></th>
                    </tr>
                </table>
                <hr class="dashed-line">
            </div> -->

        </div>

        <div id="sections">

            <section id="menu" class="step">
                <div>
                    <header id=heading class="fancyFont">
                        <h1>Fishy Business</h1>
                        <h2>The cost of your filet from fish to sea</h2>
                    </header>
                    <h3 id="author">By Estelle Hooper, Eva Ruse, Gabriella Chu</h3>
                    <p>Welcome to our restaurant. I'm your server, Fishy Business.</p>
                    <p>Please order any of our specials!</p>
                    <div id='scrollInfo' class="invisible">
                        <h4 id="scrollText" class="textCenter bounce">Scroll to continue</h4>
                        <div class="scroll-down"></div>
                    </div>

                </div>
            </section>

            <div id="hiddenSections" class="hidden">

                <section id="text1" class="step" height="100vh">
                    <p>We hope you enjoyed your meal!</p>
                    <p>However, it looks like there are some extra costs...</p>
                </section>

                <section id="text2" class="step" height="100vh">
                    <!-- DO NOT DELETE MUST LEAVE EMPTY -->
                </section>

                <section id="text3" class="step" height="100vh">
                    <!-- DO NOT DELETE MUST LEAVE EMPTY -->
                </section>

                <section id="text4" class="step" height="100vh">
                    <!-- DO NOT DELETE MUST LEAVE EMPTY -->
                </section>

                <section id="text5" class="step" height="100vh">
                    <!-- DO NOT DELETE MUST LEAVE EMPTY -->
                </section>
            </div>


        </div>
        <div id="chartContainer">
            <svg id="bar1" height="500" width="600"></svg>
        </div>
    </div>

    <div class = "testing hidden"> Idk </div>
    <!-- <main>



        <div id="graphic" class="hidden">
            <div id="sections">
                <section class="step">
                    <div class="receipt">
                        <h4> The Cost of Your Filet </h4>
                        <h5> From Plate to Sea </h5>
                        <h6> Address: blah blah 123 st</h6>
                        <h6 id='foodOrder'></h6>
                        <hr class="dashed-line">
                        <p id="water"></p>
                        <p id="land"></p>
                        <p id="nitrogen"></p>
                        <p id="phosphorous"></p>
                    </div>
                </section>
                <section class="step">
                    <div class="receipt">
                        <h4> The Cost of Your Filet </h4>
                        <h5> From Plate to Sea </h5>
                        <h6> Address: blah blah 123 st</h6>
                        <h6 id='foodOrder'></h6>
                        <hr class="dashed-line">
                        <p id="water"></p>
                        <p id="land"></p>
                        <p id="nitrogen"></p>
                        <p id="phosphorous"></p>
                    </div>
                </section>
                <section class="step">
                    <div class="receipt">
                        <h4> The Cost of Your Filet </h4>
                        <h5> From Plate to Sea </h5>
                        <h6> Address: blah blah 123 st</h6>
                        <h6 id='foodOrder'></h6>
                        <hr class="dashed-line">
                        <p id="water"></p>
                        <p id="land"></p>
                        <p id="nitrogen"></p>
                        <p id="phosphorous"></p>
                    </div>
                </section>
                <section class="step">
                    <div class="receipt">
                        <h4> The Cost of Your Filet </h4>
                        <h5> From Plate to Sea </h5>
                        <h6> Address: blah blah 123 st</h6>
                        <h6 id='foodOrder'></h6>
                        <hr class="dashed-line">
                        <p id="water"></p>
                        <p id="land"></p>
                        <p id="nitrogen"></p>
                        <p id="phosphorous"></p>
                    </div>
                </section>
            </div>
            <div id="vis">
                <svg id="bar1" height="500" width="600"></svg>
            </div>
        </div>

        <div id="map" class="hidden">
            <svg id="choropleth" height="600" width="900" style="background: #EEEEEE; margin-top:50px"></svg>
        </div>
    </main> -->
</body>

<script>
    // d3.selectAll(".menuTitle").
    // const map_svg = d3.select("#choropleth");
    // const map_width = map_svg.attr("width");
    // const map_height = map_svg.attr("height");
    // const map_margin = { top: 20, right: 20, bottom: 20, left: 20 };
    // const mapWidth = map_width - map_margin.left - map_margin.right;
    // const mapHeight = map_height - map_margin.top - map_margin.bottom;
    // const map = map_svg.append("g")
    //     .attr("transform", "translate(" + map_margin.left + "," + map_margin.top + ")");



    const chart1 = d3.select("#bar1");
    const width1 = chart1.attr("width");
    const height1 = chart1.attr("height");
    const margin1 = { top: 35, right: 10, bottom: 45, left: 150 };
    const chartWidth1 = width1 - margin1.left - margin1.right;
    const chartHeight1 = height1 - margin1.top - margin1.bottom;
    let annotations1 = chart1.append("g").attr("id", "annotations");
    const chartArea1 = chart1.append("g").attr("transform", "translate(" + margin1.left + "," + margin1.top + ")");

    const getData = async function () {

        let water_use = await d3.csv("data/freshwater-use-seafood.csv", d3.autotype);
        let land_use = await d3.csv("data/land-use-seafood.csv", d3.autotype);
        let nitrogen_emissions = await d3.csv("data/nitrogen-emissions-seafood.csv", d3.autotype);
        let phos_emissions = await d3.csv("data/phosphorous-emissions-seafood.csv", d3.autotype);


        // can either be Salmon, Shrimp, or Tilapia
        salmon_water_use = water_use.filter(d => d.Entity === 'Salmon (farmed)')[0]['Freshwater use (m3 / kg edible weight)']
        tilapia_water_use = water_use.filter(d => d.Entity === 'Tilapia (farmed)')[0]['Freshwater use (m3 / kg edible weight)']
        shrimp_water_use = water_use.filter(d => d.Entity === 'Shrimp (farmed)')[0]['Freshwater use (m3 / kg edible weight)']

        salmon_land_use = land_use.filter(d => d.Entity === 'Salmon (farmed)')[0]['Land use (m2 / kg edible weight)']
        tilapia_land_use = land_use.filter(d => d.Entity === 'Tilapia (farmed)')[0]['Land use (m2 / kg edible weight)']
        shrimp_land_use = land_use.filter(d => d.Entity === 'Shrimp (farmed)')[0]['Land use (m2 / kg edible weight)']

        salmon_nitrogen_emissions = nitrogen_emissions.filter(d => d.Entity === 'Salmon (farmed)')[0]['Nitrogen (kgN / t edible weight)']
        tilapia_nitrogen_emissions = nitrogen_emissions.filter(d => d.Entity === 'Tilapia (farmed)')[0]['Nitrogen (kgN / t edible weight)']
        shrimp_nitrogen_emissions = nitrogen_emissions.filter(d => d.Entity === 'Shrimp (farmed)')[0]['Nitrogen (kgN / t edible weight)']

        salmon_phos_emissions = phos_emissions.filter(d => d.Entity === 'Salmon (farmed)')[0]['Phosphorous (kgP / t edible weight)']
        tilapia_phos_emissions = phos_emissions.filter(d => d.Entity === 'Tilapia (farmed)')[0]['Phosphorous (kgP / t edible weight)']
        shrimp_phos_emissions = phos_emissions.filter(d => d.Entity === 'Shrimp (farmed)')[0]['Phosphorous (kgP / t edible weight)']


        // const chart1 = d3.select("#bar1");
        // const width1 = chart1.attr("width");
        // const height1 = chart1.attr("height");
        // const margin1 = { top: 35, right: 10, bottom: 45, left: 150 };
        // const chartWidth1 = width1 - margin1.left - margin1.right;
        // const chartHeight1 = height1 - margin1.top - margin1.bottom;
        // let annotations1 = chart1.append("g").attr("id", "annotations");
        // const chartArea1 = chart1.append("g").attr("transform", "translate(" + margin1.left + "," + margin1.top + ")");


        initialEstelle = async function () {
            console.log('initialEstelle')

            d3.select("#chartContainer").style('opacity', 0)


            currentDish = d3.selectAll('.currentDish').classed('fadeIn', false);
            await currentDish.transition().style('opacity', 0).end();

            // currentDish.remove();
            addReceipt = true;

            menu = d3.select(".menu")
            menu.classed("hidden", false);
            menu.transition().style('opacity', 1).style('transform', "translateX(0px)")

            receipt = d3.select(".receipt")
            receipt.selectAll(".receiptText").remove();

            receipt.classed("hidden", true);
            receipt.transition().style('opacity', 1).style('transform', "translateX(0px)")


        }

        estelle1 = async function () {
            console.log('estelle1')

            d3.select("#chartContainer").style('opacity', 0)

            menu = d3.select(".menu")
            await menu.transition().style('opacity', 0).style('transform', "translateX(-200px)").end()
            console.log(menu);

            receipt = d3.select('.receipt')
            receipt.selectAll(".receiptText").remove();
            receipt.selectAll(".dashed-line").remove();
            console.log(selectedFish)

            if (addReceipt == true) {
                menu.classed('hidden', true);
                menu.attr("height", 0)
                //add our receipt stuff

                receipt.classed('hidden', false);
                receipt.select("h2").text("Fishy Business").attr('class', 'receiptText').classed('fadeIn', true)
                receipt.select("h3").text("www.fishy-business.com").attr('class', 'receiptText').classed('fadeIn', true)

                // receipt.append('h4').text('The Cost of Your Filet').attr('class', 'receiptText').classed('fadeIn', true)
                // receipt.append('h5').text('From Plate to Sea').attr('class', 'receiptText').classed('fadeIn', true)


                if (selectedFish === 'salmon') {
                    dish = "Miso Salmon"
                    price = "$31"
                }
                else if (selectedFish === 'shrimp') {
                    dish = "Spicy Cajun Shrimp"
                    price = "$27"
                }
                else if (selectedFish === 'tilapia') {
                    dish = "Fried Tilapia Sandwich"
                    price = "$23"
                }


                receipt.select("#dishName").text(dish).classed('fadeIn', true)
                receipt.select("#dishPrice").text(price).classed('fadeIn', true)


                // addDish.append('img').attr('src', "images/" + selectedFish + ".jpg").attr('class', 'currentDish').classed('fadeIn', true);
                console.log('executed')
                addReceipt = false

                // we hard coded text opacity here but idk 
                d3.select("#text1").transition().style('opacity', 1);
                // d3.select("#text2").transition().style('opacity', 0);


            }
            receiptText = d3.select('.receiptText').classed('fadeIn', false);


        }

        addWater = async function () {
            console.log('addWater');
            receipt = d3.select(".receipt")

            await d3.select("#chartContainer").transition().style('opacity', 1).end()


            // drawChart(water_use, barScale1, leftAxisScale1,'Freshwater use (m3 / kg edible weight)');

            chartArea1.selectAll('rect.bar').data(water_use)
                .join('rect')
                .attr('class', 'bar')
                .attr("fill", d => highlightBar(d.Entity.split('(')[0].substr(0, d.Entity.split('(')[0].length - 1)))
                .attr('x', d => barScale1(0))
                .attr('y', d => leftAxisScale1(d.Entity.split('(')[0].substr(0, d.Entity.split('(')[0].length - 1)))
                .attr("height", leftAxisScale1.bandwidth())
                .attr("width", d => barScale1(Number(d['Freshwater use (m3 / kg edible weight)'])) - barScale1(0))


            // receiptText = d3.select('.receiptText').style('transform', "translateX(0px)");
            // receiptText.transition().style('opacity', 0).style('transform', "translateX(-200px)");

            // d3.select('.receipt').classed('hidden',false);
            // we hard coded text opacity here but idk 


            receipt.select("#water").text('Water').classed('fadeIn', true)
            receipt.select("#waterPrice").text(fish_water_use).classed('fadeIn', true)
        }

        addLand = function () {
            console.log('addLand')

            drawChart(land_use, barScale2, leftAxisScale1, 'Land use (m2 / kg edible weight)')

            receipt = d3.select(".receipt")



            receipt.select("#land").text('Land').classed('fadeIn', true)
            receipt.select("#landPrice").text(fish_land_use).classed('fadeIn', true)

        }

        addNitrogen = function () {
            console.log('addNitrogen')

            drawChart(nitrogen_emissions, barScale3, leftAxisScale1, 'Nitrogen (kgN / t edible weight)')

            receipt = d3.select(".receipt")



            receipt.select("#nitrogen").text('Nitrogen').classed('fadeIn', true)
            receipt.select("#nitrogenPrice").text(fish_nitrogen_emissions).classed('fadeIn', true)

        }

        addPhos = function () {
            console.log('addPhos')

            drawChart(phos_emissions, barScale4, leftAxisScale1, 'Phosphorous (kgP / t edible weight)')

            receipt = d3.select(".receipt")



            receipt.select("#phos").text('Phosphorous').classed('fadeIn', true)
            receipt.select("#phosPrice").text(fish_phos_emissions).classed('fadeIn', true)

        }

        // waterbar = async function () 

        function createScales() {
            // Setting up scales and axes for the 4 bar charts (do we need 4 separate bar charts or should we update the same one?)

            //removing "(farmed)" from each of the fish entities
            species = water_use.map(d => d.Entity.split('(')[0].substr(0, d.Entity.split('(')[0].length - 1))

            //making scales and axes for water
            water_values = water_use.map(d => Number(d['Freshwater use (m3 / kg edible weight)']))
            land_values = land_use.map(d => Number(d['Land use (m2 / kg edible weight)']))
            nitrogen_values = nitrogen_emissions.map(d => Number(d['Nitrogen (kgN / t edible weight)']))
            phos_values = phos_emissions.map(d => Number(d['Phosphorous (kgP / t edible weight)']))

            leftAxisScale1 = d3.scaleBand().domain(species).range([chartHeight1, 0]).padding(0.05);

            barvalueExtent1 = d3.extent(water_values)
            barScale1 = d3.scaleLinear().domain([0, barvalueExtent1[1]]).range([0, chartWidth1]);
            console.log('barscale1')
            console.log(barScale1)

            let leftAxis1 = d3.axisLeft();
            let leftAxisG1 = annotations1.append("g")
                .attr("class", "y-axis")
                // .attr("opacity", 0)
                .attr("transform", `translate(${margin1.left - 1}, ${margin1.top})`);
            leftAxis1.scale(leftAxisScale1);
            leftAxisG1.transition().call(leftAxis1);

            let bottomAxis1 = d3.axisBottom();
            let bottomAxisG1 = annotations1.append("g")
                .attr("class", "x-axis")
                // .attr("opacity", 0)
                .attr("transform", `translate(${margin1.left - 1},${chartHeight1 + margin1.top})`)

            bottomAxis1.scale(barScale1);
            bottomAxisG1.transition().call(bottomAxis1);

            //making scales and axes for land
            barvalueExtent2 = d3.extent(land_values)
            barScale2 = d3.scaleLinear().domain([0, barvalueExtent2[1]]).range([0, chartWidth1]);

            //making scales and axes for nitrogen
            barvalueExtent3 = d3.extent(nitrogen_values)
            barScale3 = d3.scaleLinear().domain([0, barvalueExtent3[1]]).range([0, chartWidth1]);

            //making scales for phos
            barvalueExtent4 = d3.extent(phos_values)
            barScale4 = d3.scaleLinear().domain([0, barvalueExtent4[1]]).range([0, chartWidth1]);
        }

        createScales();

        d3.selectAll(".menuTitle")
            .on('click', orderUp)


        // global variable for fish selection: salmon, shrimp, tilapia
        var selectedFish = null

        // global boolean to track if the receipt should be added
        var addReceipt = false

        function orderUp() {

            initialEstelle();

            scroll()
            console.log('scroll happened')

            addReceipt = true;



            // d3.selectAll('p').classed('hidden', false)

            menu = d3.select(".menu")
            orders = d3.selectAll(".order")
            menuTitles = d3.selectAll('.menuTitle')

            // the ones the user didn't select, make beige
            menuTitles.classed('orderNotSelected', true)
            orders.classed('orderNotSelected', true)
            d3.select(this).classed('orderNotSelected', false)
            d3.select(this.parentNode).classed('orderNotSelected', false)

            // cannot click another selection
            menu.style("pointer-events", "none")

            // turn off fading text
            menuSection = d3.select('section#menu')
            menuSection.selectAll(".fadeInOut").classed("fadeInOut", false)

            // make arrow visible
            d3.select('#scrollInfo').classed('invisible', false).classed('fadeIn', true);

            console.log('orderup')

            selectedFish = this.id;

            // d3.select('.menu').style('display', 'none')
            // d3.select('#menuContainer').style('display', 'none')

            if (selectedFish === 'salmon') {
                fish_water_use = salmon_water_use
                fish_land_use = salmon_land_use
                fish_nitrogen_emissions = salmon_nitrogen_emissions
                fish_phos_emissions = salmon_phos_emissions
            }
            else if (selectedFish === 'shrimp') {
                fish_water_use = shrimp_water_use
                fish_land_use = shrimp_land_use
                fish_nitrogen_emissions = shrimp_nitrogen_emissions
                fish_phos_emissions = shrimp_phos_emissions
            }
            else if (selectedFish === 'tilapia') {
                fish_water_use = tilapia_water_use
                fish_land_use = tilapia_land_use
                fish_nitrogen_emissions = tilapia_nitrogen_emissions
                fish_phos_emissions = tilapia_phos_emissions
            }

            // reveal next section
            dishSection = d3.select('#hiddenSections').classed('hidden', false);
        }


        function highlightBar(v) {
            console.log('highlightBar')
            console.log('v',v)
            console.log('selectedFish', selectedFish)
            v = v.toLowerCase();
            if (v === selectedFish) {
                return 'blue';
            }
            else { return 'darkgrey'; }
        }


        function drawChart(data, barscale, leftaxisscale, column) {
            console.log('drawChart')

            chartArea1.selectAll('rect.bar').data(data)
                .join(enter => enter.append('rect')
                    .attr('class', 'bar')
                    .attr("x", d => barscale(0))
                    .attr("y", d => leftaxisscale(d.Entity.split('(')[0].substr(0, d.Entity.split('(')[0].length - 1)))
                    .attr("height", leftaxisscale.bandwidth())
                    .attr("width", d => barscale(parseFloat(d[column])) - barscale(0))
                    .attr("opacity", 0)
                    .call(enter => enter.transition()
                        .attr('opacity', 1)),
                    update => update.call(update => update.transition()
                        .attr("fill", d => highlightBar(d.Entity.split('(')[0].substr(0, d.Entity.split('(')[0].length - 1)))

                        .attr("x", d => barscale(0))
                        .attr("y", d => leftaxisscale(d.Entity.split('(')[0].substr(0, d.Entity.split('(')[0].length - 1)))
                        .attr("height", leftaxisscale.bandwidth())
                        .attr("width", d => barscale(parseFloat(d[column])) - barscale(0))),
                    exit => exit.call(exit => exit.transition().attr('opacity', 0).remove()));
        }

        // source: https://towardsdatascience.com/how-i-created-an-interactive-scrolling-visualisation-with-d3-js-and-how-you-can-too-e116372e2c73

        let scroll = scroller().container(d3.select('#graphic'))

        let lastIndex, activeIndex = 0
        //This is where most of the magic happens. Every time the user scrolls, we receive a new index. First, we find all the irrelevant sections, and reduce their opacity. 
        scroll.on('active', function (index) {
            d3.selectAll('.step')
                .transition().duration(500)
                .style('opacity', function (d, i) { return i === index ? 1 : 0.1; });
            //Next, we selection from a range of activationFunctions (which we create), based on the index of the current section. 
            activeIndex = index
            console.log('active index')
            console.log(activeIndex);
            let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
            let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);
            console.log('scrolledSections')
            console.log(scrolledSections)
            scrolledSections.forEach(i => {
                console.log('i')
                console.log(i)
                activationFunctions[i]();
            })
            lastIndex = activeIndex;
        })
        scroll.on('progress', function (index, progress) {
            if (index == 2 & progress > 0.7) { }
        })

        let activationFunctions = [initialEstelle, estelle1, addWater, addLand, addNitrogen, addPhos]

    }

    getData();
</script>

</html>